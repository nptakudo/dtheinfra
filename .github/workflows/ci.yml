name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: '3.11'
  SCALA_VERSION: '2.12'
  JAVA_VERSION: '11'
  RUST_VERSION: 'stable'

jobs:
  # ============================================
  # Detect changed paths for selective builds
  # ============================================
  changes:
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.filter.outputs.python }}
      scala: ${{ steps.filter.outputs.scala }}
      rust: ${{ steps.filter.outputs.rust }}
      terraform: ${{ steps.filter.outputs.terraform }}
      dbt: ${{ steps.filter.outputs.dbt }}
      docker: ${{ steps.filter.outputs.docker }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            python:
              - 'apps/**/*.py'
              - 'libs/python/**'
              - 'pyproject.toml'
              - 'tests/**/*.py'
            scala:
              - 'apps/processing/spark-jobs/**'
              - 'apps/processing/flink-jobs/**'
              - 'libs/scala/**'
              - 'build.sbt'
              - 'project/**'
            rust:
              - 'apps/ingestion/stream-ingestors/**/*.rs'
              - 'libs/rust/**'
              - 'Cargo.toml'
            terraform:
              - 'infra/terraform/**'
            dbt:
              - 'apps/transformation/dbt-project/**'
            docker:
              - '**/Dockerfile'
              - 'local/docker-compose*.yml'

  # ============================================
  # Python Checks
  # ============================================
  python:
    needs: changes
    if: needs.changes.outputs.python == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Lint with ruff
        run: uv run ruff check .

      - name: Format check with ruff
        run: uv run ruff format --check .

      - name: Type check with mypy
        run: uv run mypy libs/python/

      - name: Run tests
        run: uv run pytest --cov=libs/python -v

  # ============================================
  # Scala Checks
  # ============================================
  scala:
    needs: changes
    if: needs.changes.outputs.scala == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'sbt'

      - name: Compile
        run: sbt compile

      - name: Run tests
        run: sbt test

      - name: Check formatting
        run: sbt scalafmtCheckAll

  # ============================================
  # Rust Checks
  # ============================================
  rust:
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests
        run: cargo test --all

  # ============================================
  # Terraform Validation
  # ============================================
  terraform:
    needs: changes
    if: needs.changes.outputs.terraform == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, staging, prod]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: Terraform Format Check
        run: terraform fmt -check -recursive infra/terraform/

      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: infra/terraform/environments/${{ matrix.environment }}

      - name: Terraform Validate
        run: terraform validate
        working-directory: infra/terraform/environments/${{ matrix.environment }}

  # ============================================
  # dbt Checks
  # ============================================
  dbt:
    needs: changes
    if: needs.changes.outputs.dbt == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dbt
        run: |
          uv venv
          uv pip install dbt-core dbt-spark

      - name: dbt deps
        run: |
          source .venv/bin/activate
          cd apps/transformation/dbt-project
          dbt deps || true

      - name: dbt compile
        run: |
          source .venv/bin/activate
          cd apps/transformation/dbt-project
          dbt compile --target ci || true

  # ============================================
  # Docker Build Check
  # ============================================
  docker:
    needs: changes
    if: needs.changes.outputs.docker == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate docker-compose
        run: |
          docker-compose -f local/docker-compose.yml config
          docker-compose -f local/docker-compose.core.yml config

  # ============================================
  # All Checks Passed
  # ============================================
  all-checks:
    runs-on: ubuntu-latest
    needs: [python, scala, rust, terraform, dbt, docker]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.python.result }}" == "failure" ]] || \
             [[ "${{ needs.scala.result }}" == "failure" ]] || \
             [[ "${{ needs.rust.result }}" == "failure" ]] || \
             [[ "${{ needs.terraform.result }}" == "failure" ]] || \
             [[ "${{ needs.dbt.result }}" == "failure" ]] || \
             [[ "${{ needs.docker.result }}" == "failure" ]]; then
            echo "One or more checks failed"
            exit 1
          fi
          echo "All checks passed!"
